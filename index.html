<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Report Downloader</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .filters {
            background: linear-gradient(145deg, #f8fafc, #e2e8f0);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: end;
            flex-wrap: wrap;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .filter-group input {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(72, 187, 120, 0.3);
        }

        .info {
            background: linear-gradient(145deg, #e6fffa, #b2f5ea);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #38b2ac;
        }

        .info h3 {
            color: #234e52;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .info ul {
            color: #2d3748;
            margin-left: 20px;
        }

        .info li {
            margin-bottom: 5px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #718096;
            font-size: 1.1rem;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #feb2b2;
            display: none;
        }

        .error.show {
            display: block;
        }

        .success {
            background: #f0fff4;
            color: #22543d;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #9ae6b4;
            display: none;
        }

        .success.show {
            display: block;
        }

        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š Daily Report Downloader</h1>
        
        <div class="info">
            <h3>ðŸ“‹ Report Includes:</h3>
            <ul>
                <li>Date, Order Code, SKU (comma separated)</li>
                <li>Total Quantity, Total Price, Time</li>
                <li>Customer Name, Phone Number</li>
                <li>Product Names, Order Status</li>
            </ul>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label for="fromDate">From Date:</label>
                <input type="date" id="fromDate" value="2025-10-19">
            </div>
            
            <div class="filter-group">
                <label for="toDate">To Date:</label>
                <input type="date" id="toDate">
            </div>
            
            <div class="filter-group">
                <button class="btn btn-primary" onclick="generateReport()">ðŸ“Š Generate Report</button>
            </div>
        </div>

        <div id="loading" class="loading">
            <div>ðŸ”„ Generating report... Please wait</div>
        </div>

        <div id="error" class="error"></div>
        <div id="success" class="success"></div>
    </div>

    <script>
        // Set today's date as default
        document.getElementById('toDate').value = new Date().toISOString().split('T')[0];

        function showLoading() {
            document.getElementById('loading').classList.add('show');
            document.getElementById('error').classList.remove('show');
            document.getElementById('success').classList.remove('show');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }

        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').classList.add('show');
            document.getElementById('success').classList.remove('show');
        }

        function showSuccess(message) {
            document.getElementById('success').textContent = message;
            document.getElementById('success').classList.add('show');
            document.getElementById('error').classList.remove('show');
        }

        // Supabase configuration
        const SUPABASE_URL = 'https://zlqrriylihuqqrnslfhs.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpscXJyaXlsaWh1cXFybnNsZmhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzIwOTY5NjksImV4cCI6MjA0NzY3Mjk2OX0.M60L5l9o61F_By8o_tEUA77L3VXgi1bRPrP6iz0_yfM';

        // Function to escape CSV values to download
        function escapeCSV(value) {
            if (value === null || value === undefined) return '';
            const stringValue = String(value);
            if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                return `"${stringValue.replace(/"/g, '""')}"`;
            }
            return stringValue;
        }

        // Function to extract data from nested JSON
        function extractJsonValue(jsonObj, path) {
            if (!jsonObj || typeof jsonObj !== 'object') return '';
            const keys = path.split('.');
            let value = jsonObj;
            for (const key of keys) {
                value = value?.[key];
                if (value === undefined || value === null) return '';
            }
            return value;
        }

        // Function to fetch orders from Supabase
        async function fetchOrdersFromSupabase(startDate, endDate) {
            const fromDate = startDate + 'T00:00:00Z';
            const toDate = endDate + 'T23:59:59Z';
            
            const url = `${SUPABASE_URL}/rest/v1/orders?select=id,order_code,status,total,final_total,created_at,updated_at,meta_data,customers(*),order_items(*,products(*))&created_at=gte.${fromDate}&created_at=lte.${toDate}&order=created_at.desc`;
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        }

        // Function to transform order data for CSV
        function transformOrderData(orders) {
            const reportData = [];
            
            orders.forEach(order => {
                const customer = order.customers || {};
                const metaData = order.meta_data || {};
                
                // Extract customer name from metadata first, then customer table
                const customerName = extractJsonValue(metaData, 'full_name') || 
                                    extractJsonValue(metaData, 'customer_name') || 
                                    extractJsonValue(metaData, 'name') ||
                                    customer.full_name || '';
                
                // Extract phone number
                const phoneNumber = customer.phone || 
                                  extractJsonValue(metaData, 'phone_number') || 
                                  extractJsonValue(metaData, 'phone') || '';
                
                // Collect product information
                const productNames = [];
                const productSkus = [];
                let totalQuantity = 0;
                
                if (order.order_items && order.order_items.length > 0) {
                    order.order_items.forEach(item => {
                        const product = item.products || {};
                        const quantity = item.quantity || 0;
                        
                        if (product.name) {
                            productNames.push(product.name);
                        }
                        if (product.sku) {
                            productSkus.push(product.sku);
                        }
                        
                        totalQuantity += quantity;
                    });
                }
                
                // Format time
                const orderTime = order.created_at ? 
                    new Date(order.created_at).toLocaleTimeString('en-IN', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        second: '2-digit'
                    }) : '';
                
                // Format date
                const orderDate = order.created_at ? 
                    new Date(order.created_at).toLocaleDateString('en-IN') : '';
                
                // Get original status
                const orderStatus = order.status || 'Unknown';
                
                reportData.push({
                    'Date': orderDate,
                    'Order Code': order.order_code || '',
                    'SKU': productSkus.join(', '),
                    'Total Quantity': totalQuantity,
                    'Total Price': parseFloat(order.final_total || order.total || 0),
                    'Time': orderTime,
                    'Name': customerName,
                    'Phone Number': phoneNumber,
                    'Product Names': productNames.join(', '),
                    'Status': orderStatus
                });
            });
            
            return reportData;
        }

        // Function to export data to CSV
        function exportToCSV(data, filename) {
            if (data.length === 0) {
                throw new Error('No data to export!');
            }
            
            const headers = Object.keys(data[0]);
            let csvContent = headers.map(header => escapeCSV(header)).join(',') + '\n';
            
            data.forEach(row => {
                const values = headers.map(header => escapeCSV(row[header]));
                csvContent += values.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function generateReport() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;

            if (!fromDate || !toDate) {
                showError('Please select both start and end dates');
                return;
            }

            if (new Date(fromDate) > new Date(toDate)) {
                showError('Start date cannot be after end date');
                return;
            }

            showLoading();

            try {
                // Fetch orders from Supabase
                const orders = await fetchOrdersFromSupabase(fromDate, toDate);
                
                if (orders.length === 0) {
                    throw new Error('No orders found for the selected date range!');
                }
                
                // Transform data
                const reportData = transformOrderData(orders);
                
                // Create filename
                const filename = `daily_report_${fromDate}_to_${toDate}.csv`;
                
                // Export to CSV
                exportToCSV(reportData, filename);
                
                showSuccess(`âœ… Report generated successfully! Downloaded ${reportData.length} records.`);
                
            } catch (error) {
                console.error('Error:', error);
                showError('Failed to generate report: ' + error.message);
            } finally {
                hideLoading();
            }
        }
    </script>
</body>
</html>
